<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>reveal.js - The HTML Presentation Framework</title>

		<meta name="description" content="A framework for easily creating beautiful presentations using HTML">
		<meta name="author" content="Hakim El Hattab">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">

		<link rel="stylesheet" href="css/reveal.min.css">
		<link rel="stylesheet" href="css/my-stuff.css">
		<link rel="stylesheet" href="css/theme/night.css" id="theme">

		<!-- For syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- If the query includes 'print-pdf', use the PDF print sheet -->
		<script>
			document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
		</script>

		<script>
			window.onload = function() {

				/********************************************************************/
				/*************** First slide ****************************************/
				/********************************************************************/
				var raphael = Raphael("holder");

				width_multiplier = 140;
				round_corners = 10;

				between_boxes = 10;

				type_width = 1 * width_multiplier;
				padding_width = 2 * width_multiplier;
				repeat_width = 4 * width_multiplier

				var recttype = raphael.rect(0, 0, type_width, width_multiplier, round_corners);
				var rectpadding = raphael.rect(type_width + between_boxes, 0, padding_width, width_multiplier, round_corners);
				var rectrepeat = raphael.rect(type_width + padding_width + between_boxes * 2, 0, repeat_width, width_multiplier, round_corners);

				var typetext = raphael.text(width_multiplier / 2, width_multiplier / 2, "request\ntype\n\n1 byte");
				var paddingtext = raphael.text(type_width + between_boxes + padding_width / 2, width_multiplier / 2, "heartbeat\nlength\n\n2 bytes");
				var repeattext = raphael.text(type_width + between_boxes * 2 + padding_width + repeat_width / 2, width_multiplier / 2, "heartbeat text...\n4 bytes");

				recttype.attr("fill", "#ccc").attr("stroke", "#fff");
				rectpadding.attr("fill", "#ccc").attr("stroke", "#fff");
				rectrepeat.attr("fill", "#ccc").attr("stroke", "#fff");

				typetext.attr("fill", "#000").attr("font-size", "32").attr("font-weight", "bold");
				paddingtext.attr("fill", "#000").attr("font-size", "32").attr("font-weight", "bold");
				repeattext.attr("fill", "#000").attr("font-size", "32").attr("font-weight", "bold");

				var already_run = false;
				var add_thing = function () {
					if (already_run) return;

					var goodtext = raphael.text(type_width + between_boxes + padding_width / 2, width_multiplier + width_multiplier / 2, "↑\n4");
					goodtext.attr("fill", "#0a0").attr("font-size", 32).attr("font-weight", "bold");

					var circle = raphael.circle(type_width + between_boxes + padding_width / 2, width_multiplier + width_multiplier / 2 + width_multiplier / 6, 20);
					circle.attr("stroke", "#fff").attr("stroke-width", 5);

					var path = raphael.path("M" + (type_width + between_boxes + padding_width / 2 + 20) + " " +
																				(width_multiplier + width_multiplier / 2 + width_multiplier / 6) +
																	"L" + (type_width + between_boxes * 2 + padding_width + repeat_width / 2 - 60) + " " +
																				(width_multiplier / 2 + 20));
					path.attr("stroke", "#fff").attr("stroke-width", 5);

					already_run = true;
				}

				rectpadding.click(add_thing);
				paddingtext.click(add_thing);


				/********************************************************************/
				/*************** Second slide ***************************************/
				/********************************************************************/
				var raphael2 = Raphael("holder2");

				width_multiplier = 140;
				round_corners = 10;

				between_boxes = 10;

				type_width = 1 * width_multiplier;
				padding_width = 2 * width_multiplier;
				repeat_width = 4 * width_multiplier

				var recttype2 = raphael2.rect(0, 0, type_width, width_multiplier, round_corners);
				var rectpadding2 = raphael2.rect(type_width + between_boxes, 0, padding_width, width_multiplier, round_corners);
				var rectrepeat2 = raphael2.rect(type_width + padding_width + between_boxes * 2, 0, repeat_width, width_multiplier, round_corners);

				var typetext2 = raphael2.text(width_multiplier / 2, width_multiplier / 2, "request\ntype\n\n1 byte");
				var paddingtext2 = raphael2.text(type_width + between_boxes + padding_width / 2, width_multiplier / 2, "heartbeat\nlength\n\n2 bytes");
				var repeattext2 = raphael2.text(type_width + between_boxes * 2 + padding_width + repeat_width / 2, width_multiplier / 2, "heartbeat text...\n4 bytes");
				var eviltext2 = raphael2.text(type_width + between_boxes + padding_width / 2, width_multiplier + width_multiplier / 2, "↑\n65536");

				recttype2.attr("fill", "#ccc").attr("stroke", "#fff");
				rectpadding2.attr("fill", "#ccc").attr("stroke", "#fff");
				rectrepeat2.attr("fill", "#ccc").attr("stroke", "#fff");

				typetext2.attr("fill", "#888").attr("font-size", 32).attr("font-weight", "bold");
				paddingtext2.attr("fill", "#00f").attr("font-size", 32).attr("font-weight", "bold");
				repeattext2.attr("fill", "#888").attr("font-size", 32).attr("font-weight", "bold");
				eviltext2.attr("fill", "#f00").attr("font-size", 32).attr("font-weight", "bold");

				/********************************************************************/
				/**************** Third slide ***************************************/
				/********************************************************************/
				var raphael3 = Raphael("holder3");

				width_multiplier = 140;
				round_corners = 10;

				between_boxes = 10;

				type_width = 1 * width_multiplier;
				padding_width = 2 * width_multiplier;
				repeat_width = 4 * width_multiplier

				var recttype3 = raphael3.rect(0, 0, type_width, width_multiplier, round_corners);
				var rectpadding3 = raphael3.rect(type_width + between_boxes, 0, padding_width, width_multiplier, round_corners);
				var rectrepeat3 = raphael3.rect(type_width + padding_width + between_boxes * 2, 0, repeat_width, width_multiplier, round_corners);

				var typetext3 = raphael3.text(width_multiplier / 2, width_multiplier / 2, "request\ntype\n\n1 byte");
				var paddingtext3 = raphael3.text(type_width + between_boxes + padding_width / 2, width_multiplier / 2, "heartbeat\nlength\n\n2 bytes");
				var repeattext3 = raphael3.text(type_width + between_boxes * 2 + padding_width + repeat_width / 2, width_multiplier / 2, "heartbeat text...\n4 bytes");

				var eviltext3 = raphael3.text(type_width + between_boxes + padding_width / 2, width_multiplier + width_multiplier / 2, "↑\n65536");

				recttype3.attr("fill", "#ccc").attr("stroke", "#fff");
				rectpadding3.attr("fill", "#ccc").attr("stroke", "#fff");
				rectrepeat3.attr("fill", "#ccc").attr("stroke", "#fff");

				typetext3.attr("fill", "#888").attr("font-size", 32).attr("font-weight", "bold");
				paddingtext3.attr("fill", "#00f").attr("font-size", 32).attr("font-weight", "bold");
				eviltext3.attr("fill", "#f00").attr("font-size", 32).attr("font-weight", "bold");
				repeattext3.attr("fill", "#888").attr("font-size", 32).attr("font-weight", "bold");

				/********************************************************************/
				/**************** Fourth slide **************************************/
				/********************************************************************/
				var raphael4 = Raphael("holder4");

				width_multiplier = 140;
				round_corners = 10;

				between_boxes = 10;

				type_width = 1 * width_multiplier;
				padding_width = 2 * width_multiplier;
				repeat_width = 4 * width_multiplier

				var recttype4 = raphael4.rect(0, 0, type_width, width_multiplier, round_corners);
				var rectpadding4 = raphael4.rect(type_width + between_boxes, 0, padding_width, width_multiplier, round_corners);
				var rectrepeat4 = raphael4.rect(type_width + padding_width + between_boxes * 2, 0, repeat_width, width_multiplier, round_corners);

				var typetext4 = raphael4.text(width_multiplier / 2, width_multiplier / 2, "request\ntype\n\n1 byte");
				var paddingtext4 = raphael4.text(type_width + between_boxes + padding_width / 2, width_multiplier / 2, "heartbeat\nlength\n\n2 bytes");
				var repeattext4 = raphael4.text(type_width + between_boxes * 2 + padding_width + repeat_width / 2, width_multiplier / 2, "heartbeat text...\n4 bytes");

				var eviltext4 = raphael4.text(type_width + between_boxes + padding_width / 2, width_multiplier + width_multiplier / 2, "↑\n65536");

				recttype4.attr("fill", "#ccc").attr("stroke", "#fff");
				rectpadding4.attr("fill", "#ccc").attr("stroke", "#fff");
				rectrepeat4.attr("fill", "#ccc").attr("stroke", "#fff");

				typetext4.attr("fill", "#888").attr("font-size", 32).attr("font-weight", "bold");
				paddingtext4.attr("fill", "#00f").attr("font-size", 32).attr("font-weight", "bold");
				eviltext4.attr("fill", "#f00").attr("font-size", 32).attr("font-weight", "bold");
				repeattext4.attr("fill", "#888").attr("font-size", 32).attr("font-weight", "bold");
			}
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h1>HEARTBLEED</h1>
					<img style="background: none; border: none;" src="images/heartbleed.png"></img>
					<p>
						<small>Created by <a href="https://github.com/cdepillabout">Dennis</a> / <a href="http://twitter.com/cdepillabout">@cdepillabout</a></small>
					</p>

					<aside class="notes">
						<ul>
							<li>今月話題になったHeartBleedの説明をしたいと思います</li>
							<li>もともとセキュリティに興味があって</li>
							<li>最初の仕事がLinuxのセキュリティに関係している仕事でした</li>
						</ul>
					</aside>
				</section>

				<section>
					<img class="stretch" src="images/heartbleed_explanation_1.png"></img>

					<aside class="notes">
						<ul>
							<li>HeartBleedを簡単に説明しているネットコミックがあって共有したいと思います。</li>
							<li>(read the comic...)</li>
						</ul>
					</aside>
				</section>

				<section>
					<img class="stretch" src="images/heartbleed_explanation_2.png"></img>

					<aside class="notes">
					</aside>
				</section>

				<section>
					<img class="stretch" src="images/heartbleed_explanation_3.png"></img>

					<aside class="notes">
						<ul>
							<li>リクエストのサイズについて嘘を言っています。</li>
							<li>結果としては、クライアントはメモリ上の任意のデータを読み取れるんです。</li>
						</ul>
					</aside>
				</section>

				<section>
					<h2>問題のコード</h2>
					<pre style="font-size: 18px; margin-top: 40px; padding: 10px; background-color: #384048;">
<span class="keyword">int</span> dtls1_process_heartbeat(SSL *s)
{
    <span class="keyword">unsigned</span> <span class="keyword">char</span> *p = <span class="fragment highlightcode">&amp;s-&gt;s3-&gt;rrec.data[<span class="number">0</span>]</span>, *pl;
    <span class="keyword">unsigned</span> <span class="keyword">short</span> hbtype;
    <span class="keyword">unsigned</span> <span class="keyword">int</span> payload;

    hbtype = *p++;
    <span class="fragment highlightcode">n2s(p, payload);</span>
    pl = p;
    <span style="color: black">...</span>
    buffer = <span class="fragment highlightcode">OPENSSL_malloc(<span class="number">1</span> + <span class="number">2</span> + payload);</span>
    bp = buffer;

    *bp++ = TLS1_HB_RESPONSE;
    s2n(payload, bp);
    <span class="fragment highlightcode">memcpy(bp, pl, payload);</span>
    bp += payload;

    r = dtls1_write_bytes(s, TLS1_RT_HEARTBEAT, buffer,
            <span class="number">1</span> + <span class="number">2</span> + payload);
    <span style="color: black">...</span>
}</pre>

					<aside class="notes">
						<ul>
							<li>C言語がわからない人？</li>
							<li>(explain C's memory layout: stack and heap)</li>
							<li>これはクライアントからのリクエスト</li>
							<li>クライアントが渡しているリクエストのサイズをチェックしないで信じて使っちゃうところです</li>
							<li>レスポンスのメモリを確保しているところです</li>
							<li>任意のメモリをユーザに渡している</li>
						</ul>
					</aside>
				</section>

				<section>
					<h2>リクエストってどうなっている？</h2>
					<pre style="font-size: 18px; margin-top: 40px; padding: 10px; background-color: #384048;">
<span class="keyword">int</span> dtls1_process_heartbeat(SSL *s)
{
    <span class="keyword">unsigned</span> <span class="keyword">char</span> *p = <span class="always-highlightcode">&amp;s-&gt;s3-&gt;rrec.data[<span class="number">0</span>]</span>, *pl;
    <span class="keyword">unsigned</span> <span class="keyword">short</span> hbtype;
    <span class="keyword">unsigned</span> <span class="keyword">int</span> payload;
}</pre>

					<p style="margin-top: 60px;" >リクエストの構成</p>
					<div id="holder"></div>

					<aside class="notes">
						<ul>
							<li>リクエストがヒープ領域で作られている</li>
							<li>サイズのところに、リクエストサイズを書きます</li>
							<li>通常だと、サイズが小さい</li>
						</ul>
					</aside>
				</section>

				<section>
					<h2>チェック無し</h2>
					<pre style="font-size: 18px; margin-top: 40px; padding: 10px; background-color: #384048;">
    <span class="keyword">unsigned</span> <span class="keyword">int</span> payload;

    hbtype = *p++;
    <span class="always-highlightcode">n2s(p, payload);</span>
    pl = p;</pre>

					<p style="margin-top: 60px;" >リクエストの構成</p>
					<div id="holder2"></div>

					<aside class="notes">
						<ul>
							<li>チェックしないでユーザーが指定したサイズを信じてしまいます</li>
							<li>悪いユーザーだと、小さいリクエスト送ってきたのに嘘ついてサイズをとても大きく指定します</li>
						</ul>
					</aside>
				</section>

				<section>
					<h2>大きすぎるmalloc</h2>
					<pre style="font-size: 18px; margin-top: 40px; padding: 10px; background-color: #384048;">
    buffer = OPENSSL_malloc(<span class="number">1</span> + <span class="number">2</span> + <span class="always-highlightcode">payload</span>);
    bp = buffer;
</pre>

					<p style="margin-top: 60px;" >リクエストの構成</p>
					<div id="holder3"></div>

					<aside class="notes">
						<ul>
							<li>(draw on board)</li>
							<li>heap領域でレスポンスのメモリを確保</li>
						</ul>
					</aside>
				</section>

				<section>
					<h2>memcpyあるある</h2>
					<pre style="font-size: 18px; margin-top: 40px; padding: 10px; background-color: #384048;">
    <span class="keyword">unsigned</span> <span class="keyword">char</span> *p = &amp;s-&gt;s3-&gt;rrec.data[<span class="number">0</span>], *pl;
    <span style="color: black">...</span>
    hbtype = *p++;
    n2s(p, payload);
    pl = p;
    <span style="color: black">...</span>
    *bp++ = TLS1_HB_RESPONSE;
    s2n(payload, bp);
    <span class="always-highlightcode">memcpy(bp, pl, payload);</span>
    bp += payload;
</pre>

					<p style="margin-top: 60px;" >リクエストの構成</p>
					<div id="holder4"></div>

					<aside class="notes">
						<ul>
							<li>(draw on board)</li>
							<li>本当のリクエストのサイズが小さいのにそれを超えてメモリをコピーしてユーザーに返却します</li>
							<li>ユーザーは、超えた分のメモリが読めます</li>
							<li>サーバの秘密鍵を読めることもあります</li>
						</ul>
					</aside>
				</section>

				<section>
					<h1>Cが怖い</h1>
					<img style="background: none; border: none;" src="images/heartbleed.png"></img>
					<p>
						<small>fin.</small>
					</p>

					<aside class="notes">
					</aside>
				</section>

			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.min.js"></script>
		<script src="js/raphael.js"></script>

		<script>

			// Full list of configuration options available here:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
				transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

				// Parallax scrolling
				// parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
				// parallaxBackgroundSize: '2100px 900px',

				// Optional libraries used to extend on reveal.js
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
					{ src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
				]
			});

		</script>

	</body>
</html>
